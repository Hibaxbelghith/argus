{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Monitor - Argus</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }
        .main-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .card-header {
            background: linear-gradient(135deg, #e94560 0%, #c81e3d 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 15px 20px;
        }
        .video-container {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            min-height: 480px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .video-feed {
            max-width: 100%;
            height: auto;
            display: block;
        }
        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.8);
        }
        .stat-box {
            background: linear-gradient(135deg, rgba(233, 69, 96, 0.2) 0%, rgba(200, 30, 61, 0.2) 100%);
            border: 1px solid rgba(233, 69, 96, 0.3);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
        }
        .stat-box h3 {
            font-size: 2.5rem;
            margin: 10px 0;
            color: #e94560;
        }
        .detection-item {
            background: rgba(255, 255, 255, 0.05);
            border-left: 3px solid #e94560;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        .btn-start {
            background: linear-gradient(135deg, #10d18e 0%, #0ea574 100%);
            border: none;
            color: white;
            padding: 12px 30px;
            font-weight: bold;
        }
        .btn-stop {
            background: linear-gradient(135deg, #e94560 0%, #c81e3d 100%);
            border: none;
            color: white;
            padding: 12px 30px;
            font-weight: bold;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-active {
            background: #10d18e;
            animation: pulse 2s infinite;
        }
        .status-inactive {
            background: #6c757d;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .navbar-custom {
            background: rgba(26, 26, 46, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            margin-bottom: 20px;
            padding: 15px 20px;
        }
        .alert-security {
            background: linear-gradient(135deg, rgba(233, 69, 96, 0.2) 0%, rgba(200, 30, 61, 0.2) 100%);
            border: 1px solid #e94560;
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
            <div class="container-fluid">
                <a class="navbar-brand fw-bold" href="/">
                    <i class="bi bi-shield-shaded"></i> Argus Security
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'detection:home' %}">
                                <i class="bi bi-camera"></i> Image Detection
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="{% url 'detection:security_monitor' %}">
                                <i class="bi bi-webcam"></i> Live Monitor
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'detection:security_logs' %}">
                                <i class="bi bi-journal-text"></i> Security Logs
                            </a>
                        </li>
                        <li class="nav-item">
                            <span class="nav-link">
                                <i class="bi bi-person-circle"></i> {{ request.user.username }}
                            </span>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="row">
            <!-- Video Feed Column -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="bi bi-camera-video"></i> Live Security Feed
                        </h4>
                        <div>
                            <span class="status-indicator status-inactive" id="statusIndicator"></span>
                            <span id="statusText">Inactive</span>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="video-container" id="videoContainer">
                            <div class="video-overlay" id="videoOverlay">
                                <div class="text-center">
                                    <i class="bi bi-camera-video-off" style="font-size: 64px; color: #666;"></i>
                                    <h5 class="mt-3">Camera Not Active</h5>
                                    <p class="text-muted">Click "Start Monitoring" to begin</p>
                                </div>
                            </div>
                            <img src="" alt="Video Feed" class="video-feed" id="videoFeed" style="display: none;">
                        </div>
                    </div>
                </div>

                <!-- Control Panel -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-sliders"></i> Control Panel</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Camera Source</label>
                                <select class="form-select" id="cameraSourceType" onchange="updateSourceInput()">
                                    <option value="webcam">Webcam</option>
                                    <option value="video">Video File</option>
                                    <option value="ip">IP Camera</option>
                                </select>
                            </div>
                            <div class="col-md-12 mb-3" id="webcamOptions">
                                <label class="form-label">Select Webcam</label>
                                <select class="form-select" id="cameraSource">
                                    <option value="0">Default Webcam (0)</option>
                                    <option value="1">Webcam 1</option>
                                    <option value="2">Webcam 2</option>
                                </select>
                            </div>
                            <div class="col-md-12 mb-3" id="videoOptions" style="display: none;">
                                <label class="form-label">Video File Path</label>
                                <input type="text" class="form-control" id="videoPath" placeholder="e.g., media/test_video.mp4">
                                <small class="text-muted">Place video file in media/ folder</small>
                            </div>
                            <div class="col-md-12 mb-3" id="ipOptions" style="display: none;">
                                <label class="form-label">IP Camera URL</label>
                                <input type="text" class="form-control" id="ipUrl" placeholder="e.g., rtsp://192.168.1.100:554/stream">
                                <small class="text-muted">RTSP or HTTP stream URL</small>
                            </div>
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Target Classes</label>
                                <select class="form-select" id="targetClasses" multiple>
                                    {% for cls in target_classes %}
                                    <option value="{{ cls }}" selected>{{ cls|title }}</option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">Hold Ctrl to select multiple</small>
                            </div>
                        </div>
                        
                        <!-- Help Section -->
                        <div class="alert alert-info">
                            <strong><i class="bi bi-info-circle"></i> No Webcam?</strong>
                            <ul class="mb-0 mt-2">
                                <li>Use a test video file (select "Video File" above)</li>
                                <li>Download sample: <a href="https://sample-videos.com/" target="_blank" class="text-white">sample-videos.com</a></li>
                                <li>Or use IP camera/phone camera app</li>
                            </ul>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                            <button class="btn btn-start" id="startBtn" onclick="startMonitoring()">
                                <i class="bi bi-play-circle"></i> Start Monitoring
                            </button>
                            <button class="btn btn-stop" id="stopBtn" onclick="stopMonitoring()" style="display: none;">
                                <i class="bi bi-stop-circle"></i> Stop Monitoring
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics & Detections Column -->
            <div class="col-lg-4">
                <!-- Statistics -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-graph-up"></i> Statistics</h5>
                    </div>
                    <div class="card-body">
                        <div class="stat-box">
                            <i class="bi bi-box-seam" style="font-size: 2rem; color: #e94560;"></i>
                            <h3 id="currentDetections">0</h3>
                            <p class="mb-0">Current Detections</p>
                        </div>
                        <div class="stat-box">
                            <i class="bi bi-people" style="font-size: 2rem; color: #e94560;"></i>
                            <h3 id="personCount">0</h3>
                            <p class="mb-0">Persons Detected</p>
                        </div>
                        <div class="stat-box">
                            <i class="bi bi-collection" style="font-size: 2rem; color: #e94560;"></i>
                            <h3 id="totalDetections">0</h3>
                            <p class="mb-0">Total Detections</p>
                        </div>
                    </div>
                </div>

                <!-- Current Detections -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-eye"></i> Live Detections</h5>
                    </div>
                    <div class="card-body" id="detectionsContainer" style="max-height: 400px; overflow-y: auto;">
                        <p class="text-muted text-center">No detections yet</p>
                    </div>
                </div>

                <!-- Alert Info -->
                <div class="alert alert-security">
                    <i class="bi bi-info-circle"></i> <strong>Auto-Save:</strong> Snapshots are automatically saved when a person is detected.
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let isMonitoring = false;
        let detectionInterval = null;

        // Update camera source input based on type
        function updateSourceInput() {
            const type = document.getElementById('cameraSourceType').value;
            document.getElementById('webcamOptions').style.display = type === 'webcam' ? 'block' : 'none';
            document.getElementById('videoOptions').style.display = type === 'video' ? 'block' : 'none';
            document.getElementById('ipOptions').style.display = type === 'ip' ? 'block' : 'none';
        }

        // Get the selected camera source
        function getCameraSource() {
            const type = document.getElementById('cameraSourceType').value;
            if (type === 'webcam') {
                return document.getElementById('cameraSource').value;
            } else if (type === 'video') {
                return document.getElementById('videoPath').value;
            } else {
                return document.getElementById('ipUrl').value;
            }
        }

        // Start monitoring
        function startMonitoring() {
            const cameraSource = getCameraSource();
            
            // Validate input
            if (!cameraSource || cameraSource.trim() === '') {
                alert('Please enter a camera source');
                return;
            }

            const targetClassesSelect = document.getElementById('targetClasses');
            const targetClasses = Array.from(targetClassesSelect.selectedOptions).map(opt => opt.value);

            // Prepare form data
            const formData = new FormData();
            formData.append('camera_source', cameraSource);
            formData.append('target_classes', JSON.stringify(targetClasses));
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            // Send start request
            fetch('{% url "detection:start_camera" %}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    isMonitoring = true;
                    updateUI(true);
                    startVideoFeed();
                    startDetectionUpdates();
                } else {
                    alert('Failed to start monitoring: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error starting monitoring');
            });
        }

        // Stop monitoring
        function stopMonitoring() {
            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            fetch('{% url "detection:stop_camera" %}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                isMonitoring = false;
                updateUI(false);
                stopVideoFeed();
                stopDetectionUpdates();
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        // Update UI based on monitoring state
        function updateUI(active) {
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');

            if (active) {
                statusIndicator.classList.remove('status-inactive');
                statusIndicator.classList.add('status-active');
                statusText.textContent = 'Active';
                startBtn.style.display = 'none';
                stopBtn.style.display = 'inline-block';
            } else {
                statusIndicator.classList.remove('status-active');
                statusIndicator.classList.add('status-inactive');
                statusText.textContent = 'Inactive';
                startBtn.style.display = 'inline-block';
                stopBtn.style.display = 'none';
            }
        }

        // Start video feed
        function startVideoFeed() {
            const videoFeed = document.getElementById('videoFeed');
            const videoOverlay = document.getElementById('videoOverlay');
            
            videoFeed.src = '{% url "detection:video_feed" %}?' + new Date().getTime();
            videoFeed.style.display = 'block';
            videoOverlay.style.display = 'none';
        }

        // Stop video feed
        function stopVideoFeed() {
            const videoFeed = document.getElementById('videoFeed');
            const videoOverlay = document.getElementById('videoOverlay');
            
            videoFeed.src = '';
            videoFeed.style.display = 'none';
            videoOverlay.style.display = 'flex';
        }

        // Start polling for detection updates
        function startDetectionUpdates() {
            detectionInterval = setInterval(updateDetections, 1000); // Update every second
        }

        // Stop polling for detection updates
        function stopDetectionUpdates() {
            if (detectionInterval) {
                clearInterval(detectionInterval);
                detectionInterval = null;
            }
        }

        // Update detection data
        function updateDetections() {
            fetch('{% url "detection:get_detections" %}')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const detectionData = data.data;
                        
                        // Update statistics
                        document.getElementById('currentDetections').textContent = detectionData.count;
                        document.getElementById('personCount').textContent = detectionData.person_count;
                        document.getElementById('totalDetections').textContent = detectionData.total_detections;
                        
                        // Update detections list
                        updateDetectionsList(detectionData.detections);
                    }
                })
                .catch(error => {
                    console.error('Error fetching detections:', error);
                });
        }

        // Update detections list display
        function updateDetectionsList(detections) {
            const container = document.getElementById('detectionsContainer');
            
            if (detections.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No detections</p>';
                return;
            }
            
            let html = '';
            detections.forEach(det => {
                const confidencePercent = (det.confidence * 100).toFixed(0);
                html += `
                    <div class="detection-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <strong>${det.class.toUpperCase()}</strong>
                            <span class="badge bg-danger">${confidencePercent}%</span>
                        </div>
                        <small class="text-muted">Position: (${det.bbox.xmin}, ${det.bbox.ymin})</small>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (isMonitoring) {
                stopMonitoring();
            }
        });
    </script>
</body>
</html>
