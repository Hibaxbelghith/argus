{% extends 'mouvment_detection/base.html' %}

{% block extra_css %}
<style>
    .video-container {
        position: relative;
        background: #000;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    .video-container img {
        width: 100%;
        height: auto;
        display: block;
    }

    .controls {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
        flex-wrap: wrap;
    }

    .status-panel {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-top: 2rem;
    }

    .status-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .status-card h3 {
        font-size: 0.9rem;
        opacity: 0.9;
        margin-bottom: 0.5rem;
    }

    .status-card .value {
        font-size: 2rem;
        font-weight: bold;
    }

    .toggle-switch {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-top: 1rem;
    }

    .switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
    }

    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 34px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }

    input:checked+.slider {
        background-color: #48bb78;
    }

    input:checked+.slider:before {
        transform: translateX(26px);
    }

    .loading {
        text-align: center;
        padding: 2rem;
        color: #666;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <h2 style="margin-bottom: 1rem; color: #667eea;">üé• D√©tection en Temps R√©el</h2>

    <div class="video-container" id="videoContainer">
        <img id="videoFeed" src="{% url 'detection:video_feed' %}" alt="Flux vid√©o" style="display: none;">
        <div class="loading">
            <p>‚è≥ Chargement de la cam√©ra...</p>
        </div>
    </div>

    <div class="controls">
        <button class="btn btn-success" onclick="startDetection()" id="startBtn">
            ‚ñ∂Ô∏è D√©marrer la D√©tection
        </button>
        <button class="btn btn-danger" onclick="stopDetection()" id="stopBtn" style="display: none;">
            ‚èπÔ∏è Arr√™ter la D√©tection
        </button>
    </div>

    <div class="toggle-switch">
        <div>
            <label class="switch">
                <input type="checkbox" id="motionToggle" checked onchange="updateSettings()">
                <span class="slider"></span>
            </label>
            <label for="motionToggle">D√©tection de mouvement</label>
        </div>

        <div>
            <label class="switch">
                <input type="checkbox" id="faceToggle" checked onchange="updateSettings()">
                <span class="slider"></span>
            </label>
            <label for="faceToggle">D√©tection de visages</label>
        </div>
    </div>
</div>

<div class="status-panel">
    <div class="status-card">
        <h3>√âtat du Syst√®me</h3>
        <div class="value" id="systemStatus">
            <span class="status-indicator status-inactive"></span>
            Arr√™t√©
        </div>
    </div>

    <div class="status-card">
        <h3>Mouvement D√©tect√©</h3>
        <div class="value" id="motionStatus">‚ùå Non</div>
    </div>

    <div class="status-card">
        <h3>Visages D√©tect√©s</h3>
        <div class="value" id="facesCount">0</div>
    </div>

    <div class="status-card">
        <h3>Intensit√© du Mouvement</h3>
        <div class="value" id="motionIntensity">0%</div>
    </div>
</div>

<div class="card" style="margin-top: 2rem;">
    <h3 style="margin-bottom: 1rem; color: #667eea;">üìã Derniers √âv√©nements</h3>
    <div id="recentEvents">
        <p style="color: #666;">Aucun √©v√©nement r√©cent</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let statusInterval = null;
    let eventsInterval = null;

    // Charger l'image vid√©o apr√®s un court d√©lai
    window.addEventListener('load', function () {
        setTimeout(function () {
            document.getElementById('videoFeed').style.display = 'block';
            document.querySelector('.loading').style.display = 'none';
        }, 1000);

        // V√©rifier le statut initial
        checkStatus();
        loadRecentEvents();
    });

    function startDetection() {
        fetch('{% url "detection:start_detection" %}', {
            method: 'POST',
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('startBtn').style.display = 'none';
                    document.getElementById('stopBtn').style.display = 'inline-block';

                    // D√©marrer la mise √† jour du statut
                    statusInterval = setInterval(checkStatus, 1000);
                    eventsInterval = setInterval(loadRecentEvents, 5000);

                    showAlert('D√©tection d√©marr√©e avec succ√®s!', 'success');
                } else {
                    showAlert('Erreur: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                showAlert('Erreur de connexion: ' + error, 'danger');
            });
    }

    function stopDetection() {
        fetch('{% url "detection:stop_detection" %}', {
            method: 'POST',
        })
            .then(response => response.json())
            .then(data => {
                document.getElementById('startBtn').style.display = 'inline-block';
                document.getElementById('stopBtn').style.display = 'none';

                // Arr√™ter les mises √† jour
                if (statusInterval) clearInterval(statusInterval);
                if (eventsInterval) clearInterval(eventsInterval);

                updateStatusDisplay({
                    is_running: false,
                    motion_detected: false,
                    faces_detected: 0,
                    motion_intensity: 0
                });

                showAlert('D√©tection arr√™t√©e', 'info');
            })
            .catch(error => {
                showAlert('Erreur: ' + error, 'danger');
            });
    }

    function checkStatus() {
        fetch('{% url "detection:detection_status" %}')
            .then(response => response.json())
            .then(data => {
                updateStatusDisplay(data);
            })
            .catch(error => {
                console.error('Erreur lors de la v√©rification du statut:', error);
            });
    }

    function updateStatusDisplay(data) {
        // √âtat du syst√®me
        const systemStatus = document.getElementById('systemStatus');
        if (data.is_running) {
            systemStatus.innerHTML = '<span class="status-indicator status-active"></span> Actif';
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'inline-block';

            if (!statusInterval) {
                statusInterval = setInterval(checkStatus, 1000);
                eventsInterval = setInterval(loadRecentEvents, 5000);
            }
        } else {
            systemStatus.innerHTML = '<span class="status-indicator status-inactive"></span> Arr√™t√©';
        }

        // Mouvement
        document.getElementById('motionStatus').textContent =
            data.motion_detected ? '‚úÖ Oui' : '‚ùå Non';

        // Visages
        document.getElementById('facesCount').textContent = data.faces_detected || 0;

        // Intensit√©
        const intensity = Math.round((data.motion_intensity || 0) * 100);
        document.getElementById('motionIntensity').textContent = intensity + '%';
    }

    function updateSettings() {
        const enableMotion = document.getElementById('motionToggle').checked;
        const enableFace = document.getElementById('faceToggle').checked;

        const formData = new FormData();
        formData.append('enable_motion', enableMotion);
        formData.append('enable_face', enableFace);

        fetch('{% url "detection:update_settings" %}', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showAlert('Param√®tres mis √† jour', 'success');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
            });
    }

    function loadRecentEvents() {
        fetch('{% url "detection:events_api" %}?limit=5')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('recentEvents');

                if (data.events && data.events.length > 0) {
                    let html = '<table style="width: 100%; border-collapse: collapse;">';
                    html += '<tr style="background: #f7fafc; font-weight: bold;">';
                    html += '<td style="padding: 0.5rem;">Type</td>';
                    html += '<td style="padding: 0.5rem;">Heure</td>';
                    html += '<td style="padding: 0.5rem;">Visages</td>';
                    html += '<td style="padding: 0.5rem;">Intensit√©</td>';
                    html += '</tr>';

                    data.events.forEach(event => {
                        html += '<tr style="border-bottom: 1px solid #e2e8f0;">';
                        html += `<td style="padding: 0.5rem;">${event.detection_type}</td>`;
                        html += `<td style="padding: 0.5rem;">${new Date(event.timestamp).toLocaleString('fr-FR')}</td>`;
                        html += `<td style="padding: 0.5rem;">${event.faces_count}</td>`;
                        html += `<td style="padding: 0.5rem;">${Math.round(event.motion_intensity * 100)}%</td>`;
                        html += '</tr>';
                    });

                    html += '</table>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<p style="color: #666;">Aucun √©v√©nement r√©cent</p>';
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
            });
    }

    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type}`;
        alertDiv.textContent = message;

        const container = document.querySelector('.container');
        container.insertBefore(alertDiv, container.firstChild);

        setTimeout(() => {
            alertDiv.remove();
        }, 3000);
    }
</script>
{% endblock %}